<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SherLock</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
            border-bottom: 4px solid var(--primary-color);
        }
        .stat-card h3 { font-size: 2.5rem; color: var(--primary-color); margin-bottom: 0.5rem; }
        
        .action-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            margin-right: 0.25rem;
            cursor: pointer;
            border: none;
            border-radius: 50px;
            color: white;
            font-weight: 600;
            transition: transform 0.2s;
        }
        .action-btn:hover { transform: scale(1.05); }
        .btn-verify { background-color: var(--success); }
        .btn-resolve { background-color: var(--info); }
        .btn-reject { background-color: var(--danger); }
        .btn-email { background-color: var(--warning); color: #333; }
        .btn-match { background-color: #6c5ce7; }

        /* Modal */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto; 
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%; 
            max-width: 600px;
            box-shadow: var(--shadow-hover);
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="logo">üõ° SherLock Admin</a>
        <div class="nav-links">
            <span id="adminName" style="margin-right: 1rem; font-weight: 600;"></span>
            <a href="#" onclick="logout()" style="color: var(--danger);">üö™ Logout</a>
        </div>
    </nav>

    <div class="container" style="max-width: 1400px;">
        <h2 style="margin-bottom: 1.5rem;">üìä Dashboard Overview</h2>
        
        <div class="stats-grid">
            <div class="stat-card" style="border-color: var(--primary-color);">
                <h3 id="total-items">0</h3>
                <p>Total Reports</p>
            </div>
            <div class="stat-card" style="border-color: var(--warning);">
                <h3 id="pending-items">0</h3>
                <p>üü° Pending</p>
            </div>
            <div class="stat-card" style="border-color: var(--success);">
                <h3 id="verified-items">0</h3>
                <p>üü¢ Verified</p>
            </div>
            <div class="stat-card" style="border-color: var(--info);">
                <h3 id="matched-items">0</h3>
                <p>üîÅ Matched & Resolved</p>
            </div>
        </div>

        <div class="card" style="padding: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                <h3>üìã All Reports Management</h3>
                <div style="flex-grow: 1; max-width: 400px; position: relative;">
                    <input type="text" id="searchInput" placeholder="üîç Search by Student, Item, or Status..." 
                           style="width: 100%; padding: 0.8rem 1rem; border-radius: 50px; border: 2px solid #dfe6e9; outline: none;">
                </div>
            </div>
            
            <!-- Simple CSS Chart for Distribution -->
            <div style="margin-bottom: 2rem; background: #f8f9fa; padding: 1rem; border-radius: var(--radius-sm);">
                <h4 style="margin-bottom: 0.5rem; color: var(--text-light);">üìä Status Distribution</h4>
                <div style="display: flex; height: 20px; border-radius: 10px; overflow: hidden; width: 100%;">
                    <div id="chart-pending" style="background-color: var(--warning); width: 0%; transition: width 1s;" title="Pending"></div>
                    <div id="chart-verified" style="background-color: var(--success); width: 0%; transition: width 1s;" title="Verified"></div>
                    <div id="chart-resolved" style="background-color: var(--info); width: 0%; transition: width 1s;" title="Resolved"></div>
                    <div id="chart-rejected" style="background-color: var(--danger); width: 0%; transition: width 1s;" title="Rejected"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; color: var(--text-light);">
                    <span>üü° Pending</span>
                    <span>üü¢ Verified</span>
                    <span>üîµ Resolved</span>
                    <span>üî¥ Rejected</span>
                </div>
            </div>

            <div style="overflow-x: auto;">
                <table id="items-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Item Details</th>
                            <th>Student Details</th>
                            <th>Status</th>
                            <th>Potential Matches</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="7" style="text-align:center;">Loading data... ‚è≥</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeEmailModal()">&times;</span>
            <h2 style="margin-bottom: 1rem;">üìß Send Email</h2>
            <form id="emailForm">
                <div class="form-group">
                    <label>To:</label>
                    <input type="email" id="emailTo" required>
                </div>
                <div class="form-group">
                    <label>Subject:</label>
                    <input type="text" id="emailSubject" required>
                </div>
                <div class="form-group">
                    <label>Message:</label>
                    <textarea id="emailMessage" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn">üöÄ Send Email</button>
            </form>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal">
        <div class="modal-content" style="max-width: 800px; text-align: center;">
            <span class="close" onclick="closeImageModal()">&times;</span>
            <div id="imageModalContent" style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;"></div>
            <div id="imageModalActions" style="margin-top: 1.5rem; display: flex; justify-content: center; gap: 1rem;"></div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        // Ensure admin
        const { user } = checkAuth();
        if (!user || user.role !== 'admin') {
            window.location.href = 'admin-login.html';
        } else {
            document.getElementById('adminName').textContent = `Hi, ${user.name}`;
        }

        // Search functionality
        let currentSearchTerm = '';
        
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            currentSearchTerm = e.target.value.toLowerCase();
            filterTable();
        });

        function filterTable() {
            const rows = document.querySelectorAll('#items-table tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(currentSearchTerm) ? '' : 'none';
            });
        }

        async function loadDashboard() {
            try {
                const items = await fetchAPI('/items/admin');
                allItemsCache = items; // Update cache
                
                // Update stats
                const total = items.length;
                const pending = items.filter(i => i.status === 'pending').length;
                const verified = items.filter(i => i.status === 'verified').length;
                const matched = items.filter(i => i.status === 'resolved' || i.status === 'matched').length;
                const rejected = items.filter(i => i.status === 'rejected').length;

                document.getElementById('total-items').textContent = total;
                document.getElementById('pending-items').textContent = pending;
                document.getElementById('verified-items').textContent = verified;
                document.getElementById('matched-items').textContent = matched;

                // Update Chart
                if (total > 0) {
                    document.getElementById('chart-pending').style.width = (pending / total * 100) + '%';
                    document.getElementById('chart-verified').style.width = (verified / total * 100) + '%';
                    document.getElementById('chart-resolved').style.width = (matched / total * 100) + '%';
                    document.getElementById('chart-rejected').style.width = (rejected / total * 100) + '%';
                }

                // Update table
                const tbody = document.querySelector('#items-table tbody');
                
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No reports found.</td></tr>';
                    return;
                }

                tbody.innerHTML = items.map(item => {
                    const studentInfo = `
                        <strong>${item.studentName || item.user?.name || 'N/A'}</strong><br>
                        <small>${item.rollNumber || ''}</small><br>
                        <small>${item.branch || ''}</small><br>
                        ${item.studentEmail || item.user?.email ? `<span style="font-size:0.8rem; color:var(--primary-color); cursor:pointer;" onclick="openEmailModal('${item.studentEmail || item.user?.email}', 'SherLock Update: ${item.title}')">${item.studentEmail || item.user?.email} (Compose)</span>` : '<span style="font-size:0.8rem; color:#888;">No email</span>'}
                    `;

                    const itemDetails = `
                        <strong>${item.title}</strong><br>
                        <small>üé® ${item.color}</small><br>
                        <small>üìç ${item.location}</small>
                    `;

                    let matchesHtml = 'None';
                    if (item.potentialMatches && item.potentialMatches.length > 0) {
                        matchesHtml = item.potentialMatches.map(m => `
                            <div style="background:#f0f3f8; padding:5px; margin-bottom:5px; border-radius:5px; font-size:0.85rem;">
                                <strong>${m.title}</strong> (${m.type})<br>
                                <button class="action-btn btn-match" onclick="compareImages('${item._id}', '${m._id}')">üîç Compare & Match</button>
                            </div>
                        `).join('');
                    }
                    if (item.matchedWith) {
                        matchesHtml = `<span class="badge resolved">Matched with: ${item.matchedWith.title}</span>`;
                    }

                    return `
                    <tr>
                        <td>
                            <img src="${item.imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJhcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzU1NSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+'}" 
                                 class="table-thumb" 
                                 onclick="viewImage('${item._id}')"
                                 alt="Item">
                        </td>
                        <td>${new Date(item.date).toLocaleDateString()}</td>
                        <td><span class="badge ${item.type}">${item.type.toUpperCase()}</span></td>
                        <td>${itemDetails}</td>
                        <td>${studentInfo}</td>
                        <td><span class="badge ${item.status}">${item.status.toUpperCase()}</span></td>
                        <td>${matchesHtml}</td>
                        <td>
                            ${item.status === 'pending' ? `<button class="action-btn btn-verify" onclick="updateStatus('${item._id}', 'verified')">Verify</button>` : ''}
                            ${item.status === 'verified' && !item.matchedWith ? `<button class="action-btn btn-resolve" onclick="updateStatus('${item._id}', 'resolved')">Manual Resolve</button>` : ''}
                            <button class="action-btn btn-email" onclick="openEmailModal('${item.studentEmail || item.user?.email || ''}', 'Update regarding your lost item: ${item.title}')">üìß Email</button>
                            <button class="action-btn btn-reject" onclick="deleteItem('${item._id}')">üóë</button>
                        </td>
                    </tr>
                    `;
                }).join('');

                // Re-apply search filter
                if(currentSearchTerm) filterTable();

            } catch (error) {
                console.error(error);
                alert('Error loading dashboard: ' + error.message);
            }
        }

        // Image Analysis Functions
        const imageModal = document.getElementById('imageModal');
        const imageContent = document.getElementById('imageModalContent');
        const imageActions = document.getElementById('imageModalActions');
        let allItemsCache = []; // To easily find items for comparison without refetching

        // Update loadDashboard to cache items
        const originalLoadDashboard = loadDashboard;
        loadDashboard = async function() {
            try {
                const items = await fetchAPI('/items/admin');
                allItemsCache = items; // Cache for local lookups
                
                // ... (rest of the logic copied from above, but we can't easily inject it into the middle of the function via search/replace)
                // Instead, let's just rely on the SearchReplace above which REPLACED the map logic. 
                // We need to make sure 'items' variable is accessible or passed.
                // The SearchReplace above replaced the innerHTML part. 
                // Wait, I need to make sure allItemsCache is populated. 
                // The previous SearchReplace just modified the HTML generation.
                // Let's modify the fetch part in the next tool call to be safe or just re-fetch in viewImage.
                // Actually, let's just re-implement viewImage to find from DOM or fetch individual if needed, 
                // but since we have the full list in 'items' inside loadDashboard, we can't access it outside easily unless we move it to global scope.
                
                // Let's assume for now I will use findItemById helper or just fetch again for simplicity if I can't access scope.
                // But wait, I can just change the variable definition in loadDashboard to be global? No, that's messy.
                // Let's just fetch the item by ID in viewImage.
                
                // Re-running the UI logic part of loadDashboard:
                const total = items.length;
                const pending = items.filter(i => i.status === 'pending').length;
                const verified = items.filter(i => i.status === 'verified').length;
                const matched = items.filter(i => i.status === 'resolved' || i.status === 'matched').length;
                const rejected = items.filter(i => i.status === 'rejected').length;

                document.getElementById('total-items').textContent = total;
                document.getElementById('pending-items').textContent = pending;
                document.getElementById('verified-items').textContent = verified;
                document.getElementById('matched-items').textContent = matched;

                if (total > 0) {
                    document.getElementById('chart-pending').style.width = (pending / total * 100) + '%';
                    document.getElementById('chart-verified').style.width = (verified / total * 100) + '%';
                    document.getElementById('chart-resolved').style.width = (matched / total * 100) + '%';
                    document.getElementById('chart-rejected').style.width = (rejected / total * 100) + '%';
                }

                const tbody = document.querySelector('#items-table tbody');
                if (items.length === 0) {
                     tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No reports found.</td></tr>';
                     return;
                }
                
                tbody.innerHTML = items.map(item => {
                    const studentInfo = `
                        <strong>${item.studentName || item.user?.name || 'N/A'}</strong><br>
                        <small>${item.rollNumber || ''}</small><br>
                        <small>${item.branch || ''}</small><br>
                        <a href="mailto:${item.studentEmail || item.user?.email}" style="font-size:0.8rem; color:var(--primary-color);">${item.studentEmail || item.user?.email}</a>
                    `;

                    const itemDetails = `
                        <strong>${item.title}</strong><br>
                        <small>üé® ${item.color}</small><br>
                        <small>üìç ${item.location}</small>
                    `;

                    let matchesHtml = 'None';
                    if (item.potentialMatches && item.potentialMatches.length > 0) {
                        matchesHtml = item.potentialMatches.map(m => `
                            <div style="background:#f0f3f8; padding:5px; margin-bottom:5px; border-radius:5px; font-size:0.85rem;">
                                <strong>${m.title}</strong> (${m.type})<br>
                                <button class="action-btn btn-match" onclick="compareImages('${item._id}', '${m._id}')">üîç Compare & Match</button>
                            </div>
                        `).join('');
                    }
                    if (item.matchedWith) {
                        matchesHtml = `<span class="badge resolved">Matched with: ${item.matchedWith.title}</span>`;
                    }

                    return `
                    <tr>
                        <td>
                            <img src="${item.imageUrl || 'data:image/svg+xml;utf8,<svg xmlns=%27http://www.w3.org/2000/svg%27 width=%27150%27 height=%27150%27><rect width=%27100%25%27 height=%27100%25%27 fill=%27%23eef2f7%27/><text x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%237f8c8d%27 font-size=%2714%27 font-family=%27Segoe UI, Arial%27>No Image</text></svg>'}" 
                                 class="table-thumb" 
                                 onclick="viewImage('${item._id}')"
                                 alt="Item">
                        </td>
                        <td>${new Date(item.date).toLocaleDateString()}</td>
                        <td><span class="badge ${item.type}">${item.type.toUpperCase()}</span></td>
                        <td>${itemDetails}</td>
                        <td>${studentInfo}</td>
                        <td><span class="badge ${item.status}">${item.status.toUpperCase()}</span></td>
                        <td>${matchesHtml}</td>
                        <td>
                            ${item.status === 'pending' ? `<button class="action-btn btn-verify" onclick="updateStatus('${item._id}', 'verified')">Verify</button>` : ''}
                            ${item.status === 'verified' && !item.matchedWith ? `<button class="action-btn btn-resolve" onclick="updateStatus('${item._id}', 'resolved')">Manual Resolve</button>` : ''}
                            <button class="action-btn btn-email" onclick="openEmailModal('${item.studentEmail || item.user?.email || ''}', 'Update regarding your lost item: ${item.title}')">üìß Email</button>
                            <button class="action-btn btn-reject" onclick="deleteItem('${item._id}')">üóë</button>
                        </td>
                    </tr>
                    `;
                }).join('');
                
                if(currentSearchTerm) filterTable();

            } catch(e) { console.error(e); }
        }

        async function getItemById(id) {
            // Helper since we don't have a direct API for one item yet or just use the admin list
            // Optimization: Just re-fetch admin list and find.
             const items = await fetchAPI('/items/admin');
             return items.find(i => i._id === id);
        }

        async function viewImage(id) {
            const item = await getItemById(id);
            if (!item) return;

            imageContent.innerHTML = `
                <div>
                    <h3>${item.title}</h3>
                    <img src="${item.imageUrl || 'data:image/svg+xml;utf8,<svg xmlns=%27http://www.w3.org/2000/svg%27 width=%27400%27 height=%27400%27><rect width=%27100%25%27 height=%27100%25%27 fill=%27%23eef2f7%27/><text x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%237f8c8d%27 font-size=%2720%27 font-family=%27Segoe UI, Arial%27>No Image</text></svg>'}" style="max-width: 100%; max-height: 400px; border-radius: 10px; box-shadow: var(--shadow);">
                    <p style="margin-top: 1rem;">Status: <span class="badge ${item.status}">${item.status.toUpperCase()}</span></p>
                </div>
            `;
            
            imageActions.innerHTML = `
                ${item.status === 'pending' ? `<button class="action-btn btn-verify" onclick="updateStatus('${item._id}', 'verified'); closeImageModal();">‚úÖ Verify Image & Item</button>` : ''}
                <button class="action-btn btn-reject" onclick="deleteItem('${item._id}'); closeImageModal();">‚ùå Reject & Delete</button>
            `;
            
            imageModal.style.display = 'block';
        }

        async function compareImages(itemId, matchId) {
            const item = await getItemById(itemId);
            // We need the match details. Since potentialMatches in admin view only has populated fields but not full object if not deeply populated?
            // The controller populates 'potentialMatches', 'title type color location date'
            // It does NOT populate imageUrl for potentialMatches.
            // We need to fetch the matched item fully.
            // Actually, let's just fetch all items and find it.
            const allItems = await fetchAPI('/items/admin');
            const match = allItems.find(i => i._id === matchId);

            if (!item || !match) {
                alert('Could not load item details.');
                return;
            }

            imageContent.innerHTML = `
                <div style="flex: 1; min-width: 250px;">
                    <h3>Original: ${item.title}</h3>
                    <img src="${item.imageUrl || 'data:image/svg+xml;utf8,<svg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27><rect width=%27100%25%27 height=%27100%25%27 fill=%27%23eef2f7%27/><text x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%237f8c8d%27 font-size=%2718%27 font-family=%27Segoe UI, Arial%27>No Image</text></svg>'}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 10px; border: 3px solid var(--primary-color);">
                    <p>Type: ${item.type}</p>
                </div>
                <div style="display: flex; align-items: center; font-size: 2rem;">üÜö</div>
                <div style="flex: 1; min-width: 250px;">
                    <h3>Match: ${match.title}</h3>
                    <img src="${match.imageUrl || 'data:image/svg+xml;utf8,<svg xmlns=%27http://www.w3.org/2000/svg%27 width=%27300%27 height=%27300%27><rect width=%27100%25%27 height=%27100%25%27 fill=%27%23eef2f7%27/><text x=%2750%25%27 y=%2750%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 fill=%27%237f8c8d%27 font-size=%2718%27 font-family=%27Segoe UI, Arial%27>No Image</text></svg>'}" style="width: 100%; height: 300px; object-fit: cover; border-radius: 10px; border: 3px solid var(--success);">
                    <p>Type: ${match.type}</p>
                </div>
            `;

            imageActions.innerHTML = `
                <button class="action-btn btn-match" style="padding: 1rem 2rem; font-size: 1.2rem;" onclick="confirmMatch('${item._id}', '${match._id}'); closeImageModal();">‚úÖ Confirm Match</button>
            `;

            imageModal.style.display = 'block';
        }

        function closeImageModal() {
            imageModal.style.display = 'none';
        }

        async function updateStatus(id, status) {
            try {
                await fetchAPI(`/items/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                loadDashboard();
            } catch (error) {
                alert(error.message);
            }
        }

        async function confirmMatch(itemId, matchId) {
            if(!confirm('Confirm this match? This will mark both items as resolved and send an email.')) return;
            try {
                await fetchAPI(`/items/${itemId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ matchedWithId: matchId })
                });
                alert('Match confirmed and emails sent! üìß');
                loadDashboard();
            } catch (error) {
                alert(error.message);
            }
        }

        async function deleteItem(id) {
            if(!confirm('Permanently delete this item?')) return;
            try {
                await fetchAPI(`/items/${id}`, { method: 'DELETE' });
                loadDashboard();
            } catch (error) {
                alert(error.message);
            }
        }

        // Email Modal Logic
        const modal = document.getElementById('emailModal');
        const emailForm = document.getElementById('emailForm');

        function openEmailModal(to, subject) {
            document.getElementById('emailTo').value = to;
            document.getElementById('emailSubject').value = subject || 'SherLock Update';
            modal.style.display = 'block';
        }

        function closeEmailModal() {
            modal.style.display = 'none';
        }

        emailForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;

            try {
                const res = await fetchAPI('/items/email', {
                    method: 'POST',
                    body: JSON.stringify({ to, subject, message })
                });
                
                if (res.success) {
                    alert(`‚úÖ Email Sent Successfully!\nMessage ID: ${res.messageId}`);
                    closeEmailModal();
                } else {
                    alert(res.message || 'Email processed.');
                    closeEmailModal();
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        });

        window.onclick = function(event) {
            if (event.target == modal) {
                closeEmailModal();
            }
        }

        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>
